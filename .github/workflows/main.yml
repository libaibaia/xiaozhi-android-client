name: Flutter Windows Build

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:  # 手动触发选项
    inputs:
      build_type:
        description: 'Build Type'
        required: true
        default: 'release'
        type: choice
        options:
          - debug
          - release
      version_name:
        description: 'Version Name (optional)'
        required: false
        type: string

permissions:
  contents: write

jobs:
  build-windows:
    name: Build Windows
    runs-on: windows-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.29.2'
          channel: 'stable'
          cache: true

      - name: Get dependencies
        run: flutter pub get

      - name: Setup Windows Desktop
        run: |
          # 确保 Windows 桌面支持已启用
          flutter config --enable-windows-desktop
          
          # 如果还没有 Windows 平台，创建它
          if (!(Test-Path -Path "windows")) {
            flutter create --platforms=windows .
          }

      - name: Install Windows build tools
        run: |
          # 安装 Visual Studio 构建工具（如果尚未安装）
          choco install visualstudio2022buildtools -y --no-progress
          choco install visualstudio2022-workload-vctools -y --no-progress

      - name: Check Flutter doctor
        run: flutter doctor -v

      - name: Build Windows
        id: build
        run: |
          $buildType = "${{ github.event.inputs.build_type || 'release' }}"
          $versionName = "${{ github.event.inputs.version_name || '' }}"
          
          Write-Host "Building Windows $buildType version..."
          
          if ($buildType -eq "debug") {
            flutter build windows --debug
            $outputDir = "build/windows/runner/Debug"
            $outputName = "lhht-windows-debug"
          } else {
            flutter build windows --release
            $outputDir = "build/windows/runner/Release"
            $outputName = "lhht-windows-release"
          }
          
          # 如果有自定义版本名，添加到文件名
          if ($versionName -ne "") {
            $outputName = "lhht-windows-$versionName"
          }
          
          # 创建 ZIP 包
          cd $outputDir
          Compress-Archive -Path * -DestinationPath "../../../$outputName.zip" -Force
          
          # 保存路径供后续步骤使用
          echo "output_path=../../../$outputName.zip" >> $env:GITHUB_OUTPUT
          echo "output_name=$outputName.zip" >> $env:GITHUB_OUTPUT

      - name: Create Standalone Package
        run: |
          $buildType = "${{ github.event.inputs.build_type || 'release' }}"
          
          if ($buildType -eq "debug") {
            $sourceDir = "build/windows/runner/Debug"
            $packageName = "lhht-windows-debug-package"
          } else {
            $sourceDir = "build/windows/runner/Release"
            $packageName = "lhht-windows-release-package"
          }
          
          # 创建包含所有文件的包目录
          $packageDir = "build/$packageName"
          New-Item -ItemType Directory -Path $packageDir -Force
          
          # 复制所有文件
          Copy-Item -Path "$sourceDir/*" -Destination $packageDir/ -Recurse -Force
          
          # 创建启动脚本
          @'
@echo off
echo Starting Lhht AI Assistant...
start "" "Runner.exe"
echo Application started!
pause
'@ | Out-File -FilePath "$packageDir/启动程序.bat" -Encoding UTF8
          
          # 创建 README 文件
          @'
# Lhht AI Assistant Windows 版本

## 使用方法：
1. 解压此文件夹到任意位置
2. 双击运行 "启动程序.bat" 或直接运行 "Runner.exe"

## 注意事项：
- 请勿删除文件夹内的任何文件
- 建议将整个文件夹放在非系统盘
- 确保系统已安装 Visual C++ 运行时库

如有问题，请联系技术支持。
'@ | Out-File -FilePath "$packageDir/README.txt" -Encoding UTF8
          
          # 压缩整个包
          Compress-Archive -Path "$packageDir/*" -DestinationPath "build/$packageName.zip" -Force

      - name: Upload Windows Artifact
        uses: actions/upload-artifact@v4
        with:
          name: windows-build
          path: |
            build/*.zip
            build/windows-package/

      - name: Create GitHub Release (仅限标签触发)
        if: startsWith(github.ref, 'refs/tags/')
        run: |
          $tagName = "${{ github.ref }}" -replace 'refs/tags/', ''
          $releaseName = "Windows Build $tagName"
          
          echo "Creating release for tag: $tagName"
          
          # 这里可以使用 GitHub CLI 或其他方式创建发布
          # 由于权限已配置，softprops/action-gh-release 会在后续步骤中处理
          
      - name: Output Build Info
        run: |
          echo "=== 构建完成 ==="
          echo "构建类型: ${{ github.event.inputs.build_type || 'release' }}"
          echo "版本名称: ${{ github.event.inputs.version_name || '未指定' }}"
          echo "触发方式: ${{ github.event_name }}"
          echo "输出文件: ${{ steps.build.outputs.output_name }}"
