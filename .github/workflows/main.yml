name: Flutter Web Build

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:  # 手动触发选项
    inputs:
      build_mode:
        description: 'Build Mode'
        required: true
        default: 'release'
        type: choice
        options:
          - debug
          - profile
          - release
      base_href:
        description: 'Base href for deployment (optional)'
        required: false
        type: string

permissions:
  contents: write
  pages: write
  id-token: write

jobs:
  build-web:
    name: Build Flutter Web
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.29.2'
          channel: 'stable'
          cache: true

      - name: Get dependencies
        run: flutter pub get

      - name: Setup Web
        run: |
          # 确保 Web 支持已启用
          flutter config --enable-web
          
          # 如果还没有 Web 平台，创建它
          if [ ! -d "web" ]; then
            flutter create --platforms=web .
          fi

      - name: Check Flutter doctor
        run: flutter doctor -v

      - name: Build Flutter Web
        id: build
        run: |
          BUILD_MODE="${{ github.event.inputs.build_mode || 'release' }}"
          BASE_HREF="${{ github.event.inputs.base_href || '/' }}"
          
          echo "Building Flutter Web in $BUILD_MODE mode..."
          echo "Base href: $BASE_HREF"
          
          if [ "$BUILD_MODE" = "debug" ]; then
            flutter build web --debug --web-renderer canvaskit --base-href "$BASE_HREF"
            OUTPUT_NAME="lhht-web-debug"
          elif [ "$BUILD_MODE" = "profile" ]; then
            flutter build web --profile --web-renderer canvaskit --base-href "$BASE_HREF"
            OUTPUT_NAME="lhht-web-profile"
          else
            flutter build web --release --web-renderer canvaskit --base-href "$BASE_HREF"
            OUTPUT_NAME="lhht-web-release"
          fi
          
          # 添加构建时间信息
          BUILD_DATE=$(date +"%Y%m%d_%H%M%S")
          echo "build_date=$BUILD_DATE" >> $GITHUB_OUTPUT
          echo "output_name=$OUTPUT_NAME" >> $GITHUB_OUTPUT
          echo "build_mode=$BUILD_MODE" >> $GITHUB_OUTPUT

      - name: Generate version info
        run: |
          # 创建版本信息文件
          BUILD_DATE=$(date +"%Y-%m-%d %H:%M:%S")
          GIT_TAG="${{ github.ref_name }}"
          GIT_COMMIT="${{ github.sha }}"
          
          cat > build/web/version.json << EOF
          {
            "version": "${GIT_TAG:-dev}",
            "build_date": "$BUILD_DATE",
            "commit_hash": "$GIT_COMMIT",
            "build_mode": "${{ steps.build.outputs.build_mode }}",
            "flutter_version": "3.29.2"
          }
          EOF
          
          # 创建部署说明
          cat > build/web/DEPLOYMENT.md << EOF
          # Flutter Web 部署说明
          
          ## 构建信息
          - 版本: ${GIT_TAG:-dev}
          - 构建时间: $BUILD_DATE
          - 构建模式: ${{ steps.build.outputs.build_mode }}
          - Git Commit: $GIT_COMMIT
          
          ## 部署方式
          
          ### 1. 静态服务器部署
          直接将 build/web 目录上传到任何静态服务器即可。
          
          ### 2. Nginx 配置示例
          \`\`\`nginx
          server {
              listen 80;
              server_name your-domain.com;
              
              location / {
                  root /path/to/build/web;
                  try_files \$uri \$uri/ /index.html;
                  index index.html;
              }
          }
          \`\`\`
          
          ### 3. GitHub Pages 部署
          已自动配置 GitHub Pages，访问: https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/
          
          ## 注意事项
          1. 确保服务器配置了正确的 MIME 类型
          2. 如果使用子目录部署，请更新 base-href
          3. 建议启用 gzip 压缩
          EOF

      - name: Upload Web Artifact
        uses: actions/upload-artifact@v4
        with:
          name: web-build
          path: build/web/
          retention-days: 7

      - name: Setup Pages
        uses: actions/configure-pages@v4

      - name: Upload to GitHub Pages
        uses: actions/upload-pages-artifact@v3
        with:
          path: build/web/

      - name: Deploy to GitHub Pages
        if: github.event_name != 'workflow_dispatch' || github.event.inputs.deploy_to_pages == 'true'
        uses: actions/deploy-pages@v4
        id: deployment

  create-release:
    name: Create Release
    if: startsWith(github.ref, 'refs/tags/')
    needs: [build-web]
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Download Web Artifact
        uses: actions/download-artifact@v4
        with:
          name: web-build
          path: web-build

      - name: Create ZIP package
        run: |
          cd web-build
          zip -r ../lhht-web-${{ github.ref_name }}.zip .
          cd ..
          
          # 计算文件大小
          FILESIZE=$(stat -c%s "lhht-web-${{ github.ref_name }}.zip")
          echo "文件大小: $(echo "scale=2; $FILESIZE/1024/1024" | bc) MB"

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          token: ${{ github.token }}
          tag_name: ${{ github.ref_name }}
          name: Release ${{ github.ref_name }}
          draft: false
          prerelease: false
          files: |
            lhht-web-${{ github.ref_name }}.zip
          body: |
            # Flutter Web 版本发布
            
            ## 构建信息
            - 版本: ${{ github.ref_name }}
            - 构建模式: ${{ needs.build-web.outputs.build_mode }}
            - 构建时间: ${{ needs.build-web.outputs.build_date }}
            
            ## 使用说明
            
            ### 1. 在线访问
            GitHub Pages: https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/
            
            ### 2. 本地部署
            1. 下载 lhht-web-${{ github.ref_name }}.zip
            2. 解压到任意目录
            3. 使用任何 HTTP 服务器托管
            4. 访问 http://localhost:8080
            
            ### 3. 快速本地测试
            ```bash
            # 使用 Python 简单服务器
            python3 -m http.server 8080 --directory web-build/
            ```
            
            ## 文件清单
            - `lhht-web-${{ github.ref_name }}.zip` - 完整的 Web 构建包

  output-summary:
    name: Build Summary
    runs-on: ubuntu-latest
    needs: [build-web]
    if: always()
    steps:
      - name: Print Build Summary
        run: |
          echo "=== Flutter Web 构建完成 ==="
          echo "构建模式: ${{ needs.build-web.outputs.build_mode }}"
          echo "输出名称: ${{ needs.build-web.outputs.output_name }}"
          echo "构建时间: ${{ needs.build-web.outputs.build_date }}"
          echo "触发事件: ${{ github.event_name }}"
          
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "手动触发参数:"
            echo "  - 构建模式: ${{ github.event.inputs.build_mode || 'release' }}"
            echo "  - Base href: ${{ github.event.inputs.base_href || '/' }}"
          fi
          
          echo "=== 部署信息 ==="
          echo "GitHub Pages URL: https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/"
          echo "构建产物已保存为 Artifact"
